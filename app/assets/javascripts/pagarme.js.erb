$(document).ready(function() {
  
   $(document).submit(function(event) {
    if (!($('meta[name=psj]').attr('controller') == 'payments' && $('meta[name=psj]').attr('action') == 'new')) {

      return
    }
    
    
    event.preventDefault();

    var card = {}
    card.card_holder_name = $("#payment_card_holder_name").val()
    card.card_expiration_date = $("#payment_card_expiration_month").val() + '/' + $("#payment_card_expiration_year").val()
    card.card_number = $("#payment_card_number").val()
    card.card_cvv = $("#payment_card_cvv").val()

    // pega os erros de validação nos campos do form e a bandeira do cartão
    var cardValidations = pagarme.validate({card: card})

    //Então você pode verificar se algum campo não é válido
    if(!cardValidations.card.card_number)
      alert('Oops, número de cartão incorreto')

    //Mas caso esteja tudo certo, você pode seguir o fluxo
    pagarme.client.connect({ encryption_key: '<%= PagarMe.encryption_key %>' })
      .then(client => client.security.encrypt(card))
      .then(card_hash => $("#payment_card_hash").val(card_hash))
      .then(function(){
        $("#payment_card_holder_name").val('');
        $("#payment_card_expiration_month").val('');
        $("#payment_card_expiration_year").val('');
        $("#payment_card_number").val('');
        $("#payment_card_cvv").val('');
      })
      .then(
        function() {
          $("#new_payment").get(0).submit()
        }
      )
      // .then($("#new_payment").get(0).submit())
      // o próximo passo aqui é enviar o card_hash para seu servidor, e
      // em seguida criar a transação/assinatura
    return false
  })
});